<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>test_lsst_lc_catalogue</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f8fafc; color:#111827; margin:0; padding:20px;}
    .container{max-width:1100px;margin:0 auto}
    header h1{font-size:20px;margin:0 0 12px;padding:8px 0;border-bottom:1px solid #e6edf3}
    .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 0 rgba(16,24,40,0.03); margin-bottom:12px}
    label{display:inline-flex;align-items:center;gap:6px}
    input[type="text"], input[type="number"], textarea{padding:6px 8px;border-radius:8px;border:1px solid #e6edf3; width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{flex:1;min-width:150px}
    button{background:#2563eb;color:white;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:transparent;color:#111;border:1px solid #e6edf3}
    #list { max-height:420px; overflow:auto; }
    .item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px}
    .thumb{width:96px;height:64px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:11px;color:#94a3b8;overflow:hidden}
    canvas{width:100%;height:260px;border-radius:8px;background:white}
    .small{font-size:13px;color:#4b5563}
    .muted{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>test_lsst_lc_catalogue</h1></header>

    <section class="panel">
      <div class="row" style="align-items:center">
        <div class="col" style="max-width:220px">
          <label>RA <input id="ra" type="text" value="150.0"></label>
        </div>
        <div class="col" style="max-width:220px">
          <label>DEC <input id="dec" type="text" value="2.0"></label>
        </div>
        <div class="col" style="max-width:140px">
          <label>Radius [deg] <input id="radius" type="number" step="0.01" value="0.2"></label>
        </div>
        <div class="col" style="max-width:140px">
          <label>Limit (objects) <input id="limit" type="number" value="20"></label>
        </div>
        <div style="min-width:160px">
          <button id="fetchBtn">Pobierz ADQL</button>
          <button id="exportBtn" class="btn-ghost" style="margin-left:6px">Eksport CSV</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Uwaga: domyślnie wysyła POST na <code>/api/adql</code>. Jeśli używasz GitHub Pages musisz wdrożyć proxy (np. Vercel, Netlify) lub zmienić URL na CORS-enabled endpoint.</div>
    </section>

    <section class="panel" style="display:flex;gap:12px">
      <div style="flex:2;min-width:300px">
        <div class="small muted">Podgląd krzywej</div>
        <canvas id="lcCanvas"></canvas>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="prevBtn" class="btn-ghost">Prev</button>
          <button id="nextBtn" class="btn-ghost">Next</button>
          <button id="savePng" style="margin-left:auto">Zapisz PNG</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Adnotacje</div>
          <input id="name" type="text" placeholder="Nazwa (opcjonalnie)" style="margin-top:6px;">
          <input id="category" type="text" placeholder="Kategoria (opcjonalnie)" style="margin-top:6px;">
          <textarea id="note" rows="3" placeholder="Opis / notatki" style="margin-top:6px"></textarea>
          <div style="margin-top:6px">
            <button id="saveAnnotation">Zapisz</button>
          </div>
        </div>
      </div>

      <div style="flex:1;min-width:240px">
        <div class="small muted">Lista / Galeria</div>
        <div id="list" style="margin-top:8px"></div>
      </div>
    </section>

    <footer style="margin-top:12px" class="muted">Adnotacje są zapisywane lokalnie w localStorage. Aby zapisać centralnie, dodaj backend zapisu.</footer>
  </div>

<script>
/* ---------- Konfiguracja ---------- */
const ADQL_POST_URL = '/api/adql'; // <- zmień na proxy lub full TAP endpoint (uwaga na CORS)
const DEFAULT_ADQL_TABLE = `dp02_dc2_catalogs.ForcedSource`; // dostosuj jeśli trzeba

/* ---------- Helpers / ADQL builder ---------- */
function buildAdqlForRegion(ra, dec, radiusDeg, maxRows){
  // Ten ADQL jest przykładowy — dopasuj nazwy kolumn do Twojego TAP
  return `
SELECT objectId, ra, dec, mjd, psfFluxMag as mag, psfFluxMagErr as magerr, filter
FROM ${DEFAULT_ADQL_TABLE}
WHERE CONTAINS(POINT('ICRS', ra, dec), CIRCLE('ICRS', ${ra}, ${dec}, ${radiusDeg}))=1
ORDER BY objectId, mjd
LIMIT ${maxRows * 1000}
`;
}

/* ---------- Parsowanie odpowiedzi TAP (próbujemy kilku formatów) ---------- */
async function postAdql(adql){
  // wysyła JSON {adql: "..."} i oczekuje JSON zwrotny z fields + data lub rows
  const resp = await fetch(ADQL_POST_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ adql })
  });
  if (!resp.ok) throw new Error('HTTP ' + resp.status);
  const txt = await resp.text();
  try { return JSON.parse(txt); }
  catch(e){ throw new Error('Nie udało się sparsować odpowiedzi: ' + e.message + ' -> ' + txt.slice(0,300)); }
}

function parseTapJson(data){
  // obsługuje formę {fields: [{name}], data: [[...]]} oraz {rows: [...]}, lub tablica obiektów
  if (Array.isArray(data)) return data;
  if (data.rows && Array.isArray(data.rows)) return data.rows;
  if (data.data && data.fields) {
    const names = data.fields.map(f=>f.name);
    return data.data.map(r=>{
      const obj = {};
      for(let i=0;i<names.length;i++) obj[names[i]] = r[i];
      return obj;
    });
  }
  // fallback: jeśli już mamy pola w top-level keys "result" lub "data"
  if (Array.isArray(data.result)) return data.result;
  if (Array.isArray(data.data)) return data.data;
  // ostatnia próba - zwróć pustą
  return [];
}

/* ---------- Grupowanie po objectId ---------- */
function groupByObject(rows){
  const map = new Map();
  for (const r of rows){
    const oid = r.objectId ?? r.objid ?? r.id ?? r['object id'];
    if (!oid) continue;
    if (!map.has(oid)) map.set(oid, { objectId: oid, ra: parseFloat(r.ra), dec: parseFloat(r.dec), measurements: [] });
    map.get(oid).measurements.push({ mjd: Number(r.mjd), mag: Number(r.mag), magerr: Number(r.magerr), filter: r.filter });
  }
  const arr = Array.from(map.values()).map(o=>({...o, measurements: o.measurements.sort((a,b)=>a.mjd - b.mjd)}));
  return arr;
}

/* ---------- UI / State ---------- */
let objects = []; // {objectId, ra, dec, measurements, annotations, png}
let currentIndex = 0;

const listDiv = document.getElementById('list');
const fetchBtn = document.getElementById('fetchBtn');
const exportBtn = document.getElementById('exportBtn');
const lcCanvas = document.getElementById('lcCanvas');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const savePngBtn = document.getElementById('savePng');
const nameInput = document.getElementById('name');
const categoryInput = document.getElementById('category');
const noteInput = document.getElementById('note');
const saveAnnotationBtn = document.getElementById('saveAnnotation');

function saveToLocal(){
  localStorage.setItem('rle_objects_v1', JSON.stringify(objects));
}
function loadFromLocal(){
  try {
    const s = localStorage.getItem('rle_objects_v1');
    if (!s) return;
    objects = JSON.parse(s);
  } catch(e){ console.warn('localStorage parse err', e) }
}

function renderList(){
  listDiv.innerHTML = '';
  objects.forEach((o, idx)=>{
    const it = document.createElement('div'); it.className='item';
    const thumb = document.createElement('div'); thumb.className='thumb';
    if (o.png){ const img = document.createElement('img'); img.src = o.png; img.style.width='100%'; thumb.innerHTML=''; thumb.appendChild(img); } else { thumb.textContent='no png'; }
    it.appendChild(thumb);
    const info = document.createElement('div'); info.style.flex='1';
    const title = document.createElement('div'); title.textContent = o.annotations?.name || o.objectId; title.style.fontWeight='600';
    const coords = document.createElement('div'); coords.className='small muted'; coords.textContent = `${o.ra?.toFixed(5) || ''}, ${o.dec?.toFixed(5)||''}`;
    const cat = document.createElement('div'); cat.className='small'; cat.textContent = o.annotations?.category || '';
    info.appendChild(title); info.appendChild(coords); info.appendChild(cat);
    it.appendChild(info);
    const openBtn = document.createElement('button'); openBtn.textContent='Open'; openBtn.onclick = ()=>{ currentIndex = idx; renderCurrent(); };
    it.appendChild(openBtn);
    listDiv.appendChild(it);
  });
}

function renderCurrent(){
  if (objects.length===0) {
    clearCanvas(); nameInput.value=''; categoryInput.value=''; noteInput.value=''; return;
  }
  if (currentIndex < 0) currentIndex = 0;
  if (currentIndex >= objects.length) currentIndex = objects.length -1;
  const o = objects[currentIndex];
  nameInput.value = o.annotations?.name || '';
  categoryInput.value = o.annotations?.category || '';
  noteInput.value = o.annotations?.note || '';
  drawLightcurve(o.measurements);
  renderList();
}

/* ---------- Canvas drawing (simple) ---------- */
function clearCanvas(){
  const ctx = lcCanvas.getContext('2d'); ctx.clearRect(0,0,lcCanvas.width,lcCanvas.height); ctx.fillStyle='#f9fafb'; ctx.fillRect(0,0,lcCanvas.width,lcCanvas.height);
}
function drawLightcurve(meas){
  const dpr = window.devicePixelRatio || 1;
  lcCanvas.width = lcCanvas.clientWidth * dpr;
  lcCanvas.height = lcCanvas.clientHeight * dpr;
  const ctx = lcCanvas.getContext('2d'); ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,lcCanvas.clientWidth,lcCanvas.clientHeight);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,lcCanvas.clientWidth,lcCanvas.clientHeight);
  if (!meas || meas.length===0){ ctx.fillStyle='#6b7280'; ctx.fillText('Brak danych', 10,20); return; }
  const margin = 36;
  const W = lcCanvas.clientWidth, H = lcCanvas.clientHeight;
  const w = W - margin*2, h = H - margin*2;
  const mjd = meas.map(m=>m.mjd); const mag = meas.map(m=>m.mag);
  const minM = Math.min(...mjd), maxM = Math.max(...mjd);
  const minMag = Math.min(...mag), maxMag = Math.max(...mag);
  function sx(x){ return margin + ((x - minM)/( (maxM - minM) || 1 ))*w; }
  function sy(y){ return margin + (1 - ((y - minMag)/( (maxMag - minMag) || 1 )) )*h; }
  // axes
  ctx.strokeStyle = '#e6edf3'; ctx.beginPath(); ctx.moveTo(margin, margin); ctx.lineTo(margin, margin+h); ctx.lineTo(margin+w, margin+h); ctx.stroke();
  // line
  ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 1.5; ctx.beginPath();
  meas.forEach((pt,i)=>{ const x=sx(pt.mjd), y=sy(pt.mag); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  // points
  ctx.fillStyle = '#1e40af';
  meas.forEach(pt=>{ const x=sx(pt.mjd), y=sy(pt.mag); ctx.beginPath(); ctx.arc(x,y,2.6,0,Math.PI*2); ctx.fill(); });
  // labels
  ctx.fillStyle = '#374151'; ctx.font='12px sans-serif'; ctx.fillText('MJD', W/2, H-8); ctx.fillText('mag (lower = brighter)', 6, 12);
}

/* ---------- Events ---------- */
fetchBtn.addEventListener('click', async ()=>{
  fetchBtn.disabled = true; fetchBtn.textContent = 'Ładowanie...';
  try {
    const ra = document.getElementById('ra').value;
    const dec = document.getElementById('dec').value;
    const radius = document.getElementById('radius').value;
    const limit = Number(document.getElementById('limit').value) || 20;
    const adql = buildAdqlForRegion(ra, dec, radius, limit);
    const raw = await postAdql(adql);
    const rows = parseTapJson(raw);
    const objs = groupByObject(rows).slice(0, limit);
    // merge previous annotations if ids match
    loadFromLocal();
    const merged = objs.map(o=>{
      const prev = objects.find(x=>x.objectId==o.objectId);
      return prev ? {...o, annotations: prev.annotations||{}} : {...o, annotations:{name:'',category:'',note:''}};
    });
    objects = merged;
    currentIndex = 0;
    saveToLocal();
    renderCurrent();
  } catch(e){ alert('Błąd: ' + e.message); console.error(e); }
  finally { fetchBtn.disabled=false; fetchBtn.textContent='Pobierz ADQL' }
});

prevBtn.addEventListener('click', ()=>{ currentIndex = Math.max(0, currentIndex-1); renderCurrent(); });
nextBtn.addEventListener('click', ()=>{ currentIndex = Math.min(objects.length-1, currentIndex+1); renderCurrent(); });

savePngBtn.addEventListener('click', ()=>{
  if (!objects[currentIndex]) return;
  const data = lcCanvas.toDataURL('image/png');
  objects[currentIndex].png = data;
  saveToLocal();
  renderList();
  alert('Zapisano PNG (localStorage). Możesz eksportować CSV.');
});

saveAnnotationBtn.addEventListener('click', ()=>{
  if (!objects[currentIndex]) return;
  const o = objects[currentIndex];
  o.annotations = { name: nameInput.value, category: categoryInput.value, note: noteInput.value };
  objects[currentIndex] = o;
  saveToLocal();
  renderList();
  alert('Adnotacja zapisana lokalnie.');
});

exportBtn.addEventListener('click', ()=>{
  const lines = objects.map(o=>{
    const name = (o.annotations?.name||'').replace(/"/g,'""');
    const cat  = (o.annotations?.category||'').replace(/"/g,'""');
    const note = (o.annotations?.note||'').replace(/"/g,'""').replace(/\n/g,' ');
    const png  = o.png ? o.png : '';
    return `"${o.objectId}","${o.ra}","${o.dec}","${name}","${cat}","${note}","${png}"`;
  });
  const header = 'objectId,ra,dec,name,category,note,png';
  const csv = [header, ...lines].join('\\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='rubin_annotations.csv'; a.click(); URL.revokeObjectURL(url);
});

/* ---------- Init ---------- */
loadFromLocal();
renderCurrent();

</script>
</body>
</html>
