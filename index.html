<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rubin Lightcurve Explorer — demo</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f8fafc; color:#111827; margin:0; padding:20px;}
    .container{max-width:1100px;margin:0 auto}
    header h1{font-size:20px;margin:0 0 12px;padding:8px 0;border-bottom:1px solid #e6edf3}
    .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 0 rgba(16,24,40,0.03); margin-bottom:12px}
    label{display:inline-flex;align-items:center;gap:6px}
    input[type="text"], input[type="number"], textarea{padding:6px 8px;border-radius:8px;border:1px solid #e6edf3; width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{flex:1;min-width:150px}
    button{background:#2563eb;color:white;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:transparent;color:#111;border:1px solid #e6edf3}
    #list { max-height:420px; overflow:auto; }
    .item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px}
    .thumb{width:96px;height:64px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:11px;color:#94a3b8;overflow:hidden}
    canvas{width:100%;height:260px;border-radius:8px;background:white}
    .small{font-size:13px;color:#4b5563}
    .muted{color:#6b7280;font-size:13px}
    .hint{font-size:13px;color:#374151;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Rubin Lightcurve Explorer — demo</h1></header>

    <section class="panel">
      <div class="row" style="align-items:center">
        <div class="col" style="max-width:220px"><label>RA <input id="ra" type="text" value="150.0"></label></div>
        <div class="col" style="max-width:220px"><label>DEC <input id="dec" type="text" value="2.0"></label></div>
        <div class="col" style="max-width:140px"><label>Radius [deg] <input id="radius" type="number" step="0.01" value="0.2"></label></div>
        <div class="col" style="max-width:140px"><label>Limit (objects) <input id="limit" type="number" value="6"></label></div>
        <div style="min-width:170px">
          <button id="fetchBtn">Pobierz (demo)</button>
          <button id="realBtn" class="btn-ghost" style="margin-left:6px">Przełącz: użyj proxy</button>
          <button id="exportBtn" class="btn-ghost" style="margin-left:6px">Eksport CSV</button>
        </div>
      </div>
      <div class="hint">Demo: jeśli nie masz proxy/TAP -> używany jest zestaw przykładowych krzywych. Kiedy masz proxy, kliknij "Przełącz: użyj proxy" i ustaw URL proxy w konsoli (poniżej opis).</div>
    </section>

    <section class="panel" style="display:flex;gap:12px">
      <div style="flex:2;min-width:300px">
        <div class="small muted">Podgląd krzywej</div>
        <canvas id="lcCanvas"></canvas>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="prevBtn" class="btn-ghost">Prev</button>
          <button id="nextBtn" class="btn-ghost">Next</button>
          <button id="savePng" style="margin-left:auto">Zapisz PNG</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Adnotacje</div>
          <input id="name" type="text" placeholder="Nazwa (opcjonalnie)" style="margin-top:6px;">
          <input id="category" type="text" placeholder="Kategoria (opcjonalnie)" style="margin-top:6px;">
          <textarea id="note" rows="3" placeholder="Opis / notatki" style="margin-top:6px"></textarea>
          <div style="margin-top:6px"><button id="saveAnnotation">Zapisz</button></div>
        </div>
      </div>

      <div style="flex:1;min-width:240px">
        <div class="small muted">Lista / Galeria</div>
        <div id="list" style="margin-top:8px"></div>
      </div>
    </section>

    <footer style="margin-top:12px" class="muted">Adnotacje zapisują się lokalnie w localStorage. Aby użyć rzeczywistego TAP: wdroż proxy i ustaw URL w konsoli (patrz instrukcję w kodzie).</footer>
  </div>

<script>
/* ---------------- Konfiguracja ----------------
 ADQL_POST_URL: jeśli masz proxy, ustaw URL (np. https://my-proxy.vercel.app/api/adql)
 W przeglądarce możesz wywołać:
   window.setAdqlUrl('https://twoj-proxy.example.com/api/adql')
-----------------------------------------------*/
let USE_PROXY = false;                // przycisk "Przełącz: użyj proxy" zmienia to
let ADQL_POST_URL = '/api/adql';      // domylnie proxy path (zmień po wdrożeniu)
const DEFAULT_ADQL_TABLE = 'dp02_dc2_catalogs.ForcedSource'; // dopasuj gdy używasz realnego TAP

/* ---------- Demo data (pokazuje od razu zawartość) ---------- */
function makeMockObjects(n=6){
  const objs = [];
  for(let i=0;i<n;i++){
    const oid = 'MCK' + (1000+i);
    const ra = 150 + (Math.random()-0.5)*0.5;
    const dec = 2 + (Math.random()-0.5)*0.5;
    const mjd0 = 59000 + i*10;
    const meas = [];
    for(let j=0;j<30;j++){
      const mjd = mjd0 + j*1 + (Math.random()-0.5)*0.2;
      const base = 18 + (i%3) + Math.sin(j/5 + i)/3;
      const mag = base + (Math.random()-0.5)*0.2;
      meas.push({ mjd: Math.round(mjd*1000)/1000, mag: Math.round(mag*1000)/1000, magerr: 0.02 + Math.random()*0.05, filter: ['g','r','i'][j%3] });
    }
    objs.push({ objectId: oid, ra, dec, measurements: meas, annotations: { name:'', category:'', note:'' } });
  }
  return objs;
}

/* ---------- ADQL builder (jeśli użyjesz proxy) ---------- */
function buildAdqlForRegion(ra, dec, radiusDeg, maxRows){
  return `
SELECT objectId, ra, dec, mjd, psfFluxMag as mag, psfFluxMagErr as magerr, filter
FROM ${DEFAULT_ADQL_TABLE}
WHERE CONTAINS(POINT('ICRS', ra, dec), CIRCLE('ICRS', ${ra}, ${dec}, ${radiusDeg}))=1
ORDER BY objectId, mjd
LIMIT ${maxRows * 1000}
`;
}

/* ---------- post to proxy (proxy expects JSON {adql: "..."}) ---------- */
async function postAdqlViaProxy(adql){
  const resp = await fetch(ADQL_POST_URL, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ adql })
  });
  if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
  const text = await resp.text();
  try { return JSON.parse(text); } catch(e){ throw new Error('Nie udało się sparsować odpowiedzi proxy: ' + e.message); }
}

/* ---------- Parsowanie możliwych formatów ---------- */
function parseTapJson(data){
  if (Array.isArray(data)) return data;
  if (data.rows && Array.isArray(data.rows)) return data.rows;
  if (data.data && data.fields) {
    const names = data.fields.map(f=>f.name);
    return data.data.map(r => { const obj = {}; for(let i=0;i<names.length;i++) obj[names[i]] = r[i]; return obj; });
  }
  if (Array.isArray(data.result)) return data.result;
  if (Array.isArray(data.data)) return data.data;
  return [];
}

/* ---------- Grouping by objectId ---------- */
function groupByObject(rows){
  const map = new Map();
  for (const r of rows){
    const oid = r.objectId ?? r.objid ?? r.id ?? r['object id'];
    if (!oid) continue;
    if (!map.has(oid)) map.set(oid, { objectId: oid, ra: parseFloat(r.ra), dec: parseFloat(r.dec), measurements: [] });
    map.get(oid).measurements.push({ mjd: Number(r.mjd), mag: Number(r.mag), magerr: Number(r.magerr), filter: r.filter });
  }
  return Array.from(map.values()).map(o=>({...o, measurements: o.measurements.sort((a,b)=>a.mjd-b.mjd)}));
}

/* ---------- UI state ---------- */
let objects = []; // array of {objectId, ra, dec, measurements, annotations, png}
let currentIndex = 0;

/* ---------- DOM refs ---------- */
const listDiv = document.getElementById('list');
const fetchBtn = document.getElementById('fetchBtn');
const realBtn = document.getElementById('realBtn');
const exportBtn = document.getElementById('exportBtn');
const lcCanvas = document.getElementById('lcCanvas');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const savePngBtn = document.getElementById('savePng');
const nameInput = document.getElementById('name');
const categoryInput = document.getElementById('category');
const noteInput = document.getElementById('note');
const saveAnnotationBtn = document.getElementById('saveAnnotation');

/* ---------- Local storage helpers ---------- */
function saveToLocal(){ localStorage.setItem('rle_objects_v1', JSON.stringify(objects)); }
function loadFromLocal(){ try { const s=localStorage.getItem('rle_objects_v1'); if (s) objects = JSON.parse(s); } catch(e){ console.warn(e); } }

/* ---------- Render list and current ---------- */
function renderList(){
  listDiv.innerHTML = '';
  objects.forEach((o, idx)=>{
    const it = document.createElement('div'); it.className='item';
    const thumb = document.createElement('div'); thumb.className='thumb';
    if (o.png){ const img = document.createElement('img'); img.src = o.png; img.style.width='100%'; thumb.innerHTML=''; thumb.appendChild(img); } else { thumb.textContent='no png'; }
    it.appendChild(thumb);
    const info = document.createElement('div'); info.style.flex='1';
    const title = document.createElement('div'); title.textContent = o.annotations?.name || o.objectId; title.style.fontWeight='600';
    const coords = document.createElement('div'); coords.className='small muted'; coords.textContent = `${o.ra?.toFixed(5)||''}, ${o.dec?.toFixed(5)||''}`;
    const cat = document.createElement('div'); cat.className='small'; cat.textContent = o.annotations?.category || '';
    info.appendChild(title); info.appendChild(coords); info.appendChild(cat);
    it.appendChild(info);
    const openBtn = document.createElement('button'); openBtn.textContent='Open'; openBtn.onclick = ()=>{ currentIndex = idx; renderCurrent(); };
    it.appendChild(openBtn);
    listDiv.appendChild(it);
  });
}

function renderCurrent(){
  if (objects.length===0){ clearCanvas(); nameInput.value=''; categoryInput.value=''; noteInput.value=''; renderList(); return; }
  if (currentIndex<0) currentIndex=0;
  if (currentIndex>=objects.length) currentIndex=objects.length-1;
  const o = objects[currentIndex];
  nameInput.value = o.annotations?.name || '';
  categoryInput.value = o.annotations?.category || '';
  noteInput.value = o.annotations?.note || '';
  drawLightcurve(o.measurements);
  renderList();
}

/* ---------- Canvas drawing ---------- */
function clearCanvas(){ const ctx = lcCanvas.getContext('2d'); ctx.clearRect(0,0,lcCanvas.width,lcCanvas.height); ctx.fillStyle='#f9fafb'; ctx.fillRect(0,0,lcCanvas.width,lcCanvas.height); }
function drawLightcurve(meas){
  const dpr = window.devicePixelRatio || 1;
  lcCanvas.width = lcCanvas.clientWidth * dpr;
  lcCanvas.height = lcCanvas.clientHeight * dpr;
  const ctx = lcCanvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,lcCanvas.clientWidth,lcCanvas.clientHeight);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,lcCanvas.clientWidth,lcCanvas.clientHeight);
  if (!meas || meas.length===0){ ctx.fillStyle='#6b7280'; ctx.fillText('Brak danych', 10,20); return; }
  const margin = 36; const W = lcCanvas.clientWidth, H = lcCanvas.clientHeight; const w = W - margin*2, h = H - margin*2;
  const mjd = meas.map(m=>m.mjd); const mag = meas.map(m=>m.mag);
  const minM = Math.min(...mjd), maxM = Math.max(...mjd);
  const minMag = Math.min(...mag), maxMag = Math.max(...mag);
  function sx(x){ return margin + ((x - minM)/( (maxM - minM) || 1 ))*w; }
  function sy(y){ return margin + (1 - ((y - minMag)/( (maxMag - minMag) || 1 )) )*h; }
  ctx.strokeStyle = '#e6edf3'; ctx.beginPath(); ctx.moveTo(margin, margin); ctx.lineTo(margin, margin+h); ctx.lineTo
